# What is Unconstrained delegation?

This a feature that a Domain Administrator can set to any Computer inside the domain. Then, anytime a user logins onto the Computer, a copy of the TGT of that user is going to be sent inside the TGS provided by the DC and saved in memory in LSASS. So, if you have Administrator privileges on the machine, you will be able to dump the tickets and impersonate the users on any machine.

So if a domain admin logins inside a Computer with "Unconstrained Delegation" feature activated, and you have local admin privileges inside that machine, you will be able to dump the ticket and impersonate the Domain Admin anywhere (domain privesc).

## Tools

> [PowerView] (<https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView>)
>
> [Mimikatz] (<https://github.com/ParrotSec/mimikatz>)
>
> [SpoolSample] (<https://github.com/leechristensen/SpoolSample>)

### Import Module

```PS
Import-Module .\Powerview.ps1
. .\Powerview.ps1
```

You can find Computer objects with this attribute checking if the UserAccessControl attribute contains ads_us_trusted. You can do this with an LDAP filter of ‘(userAccountControl:1.2.840.113556.1.4.803:=524288)’, which is what powerview does:

```PS
Get-NetComputer -Unconstrained #DCs always appear but aren't useful for privesc
privilege::debug
sekurlsa::tickets /export #Recommended way to Export tickets
kerberos::list /export #Another way to Export tickets
```

Load the ticket of Administrator (or victim user) in memory with Mimikatz or Rubeus for a Pass thhe ticket attack.

## Automatically compromising a Print server

If an attacker is able to compromise a computer allowed for "Unconstrained Delegation", he could trick a Print server to automatically login against it saving a TGT in the memory of the server.
Then, the attacker could perform a Pass the Ticket attack to impersonate the user Print server computer account.

To make a print server login against any machine you can use SpoolSample:

```PS
.\SpoolSample.exe printmachine unconstrinedmachine
```

If the TGT if from a domain controller, you could perform a DCSync Attack and obtain all the hashes from the DC.

## Mitigation

- Limit DA/Admin logins to specific services
- Set "Account is sensitive and cannot be delegated" for privileged accounts.
